/**\n * Map - ë§µ ì‹œìŠ¤í…œ\n * ë°© ì—°ê²° ê·¸ë˜í”„ + ì´ë™ ì œì•½ + ì ê¸´ êµ¬ì—­\n */\n\nimport { MSG } from './messages.js';\nimport { buildAsciiMapLines } from './mapAscii.js';\n\nexport class GameMap {\n  constructor(game) {\n    this.game = game;\n\n    // ê¸°ë³¸ ë§µ ì—°ê²° (ê·¸ë˜í”„)\n    this.baseConnections = {\n      hub: ['reactor', 'medbay', 'storage'],\n      reactor: ['hub'],\n      medbay: ['hub'],\n      storage: ['hub', 'security'],\n      security: ['storage', 'airlock'],\n      airlock: ['security'],\n    };\n\n    this.connections = {};\n    this.lockedRooms = new Set();\n    this.hasShortcut = false;\n\n    this.initializeMap();\n  }\n\n  isTutorialRun() {\n    // íŠœí† ë¦¬ì–¼ ë¯¸ì™„ë£Œ = íŠœí† ë¦¬ì–¼ ëŸ°\n    return this.game?.tutorial && !this.game.tutorial.isCompleted();\n  }\n\n  initializeMap() {\n    // ê¸°ë³¸ ì—°ê²° ë³µì‚¬\n    this.connections = {};\n    for (const [room, conns] of Object.entries(this.baseConnections)) {\n      this.connections[room] = [...conns];\n    }\n\n    // íŠœí† ë¦¬ì–¼ ëŸ°: ëœë¤ì„± ì œê±°(ì ê¸ˆ/ë‹¨ì¶•ê²½ë¡œ ì—†ìŒ)\n    if (this.isTutorialRun()) {\n      this.hasShortcut = false;\n      this.lockedRooms.clear();\n      return;\n    }\n\n    // ë‹¨ì¶• ê²½ë¡œ í™•ë¥  (ë©”íƒ€ í•´ê¸ˆ ì‹œ +20%)\n    let shortcutChance = 0.1;\n    if (this.game.meta?.saved?.unlocks?.shortcut_chance) {\n      shortcutChance += 0.2;\n    }\n\n    if (Math.random() < shortcutChance) {\n      this.hasShortcut = true;\n      this.connections.hub.push('airlock');\n      this.connections.airlock.push('hub');\n    } else {\n      this.hasShortcut = false;\n    }\n\n    // ì ê¸´ ë°© ì„¤ì • (1~2ê°œ, hub/airlock ì œì™¸)\n    this.lockedRooms.clear();\n    const lockableRooms = ['reactor', 'medbay', 'storage', 'security'];\n    const numLocked = Math.random() < 0.3 ? 2 : (Math.random() < 0.5 ? 1 : 0);\n\n    const shuffled = [...lockableRooms].sort(() => Math.random() - 0.5);\n    for (let i = 0; i < numLocked; i++) {\n      this.lockedRooms.add(shuffled[i]);\n    }\n  }\n\n  canMove(from, to) {\n    const connected = this.connections[from];\n    if (!connected || !connected.includes(to)) {\n      const toKr = MSG.ROOMS[to] || to;\n      return {\n        canMove: false,\n        reason: MSG.MOVE_NOT_CONNECTED(to, toKr),\n      };\n    }\n\n    if (this.lockedRooms.has(to)) {\n      if (this.game.state.hasEngineerKeycard) {\n        return { canMove: true, useKeycard: true };\n      }\n\n      const toKr = MSG.ROOMS[to] || to;\n      return {\n        canMove: false,\n        reason: MSG.MOVE_LOCKED(to, toKr),\n        locked: true,\n      };\n    }\n\n    return { canMove: true };\n  }\n\n  unlockRoom(room) {\n    if (!this.lockedRooms.has(room)) return false;\n\n    const perm = this.game.state.permission;\n    if (perm === 'guest') {\n      this.game.print(MSG.PERMISSION_DENIED, 'error');\n      return false;\n    }\n\n    this.lockedRooms.delete(room);\n    return true;\n  }\n\n  useKeycardOn(room) {\n    if (!this.game.state.hasEngineerKeycard) return false;\n    if (!this.lockedRooms.has(room)) return false;\n\n    this.game.state.hasEngineerKeycard = false;\n    this.lockedRooms.delete(room);\n    return true;\n  }\n\n  getAvailableRooms(from) {\n    const connected = this.connections[from] || [];\n    return connected.map(room => ({\n      room,\n      roomKr: MSG.ROOMS[room] || room,\n      locked: this.lockedRooms.has(room),\n    }));\n  }\n\n  showMap() {\n    const current = this.game.state.location;\n    const currentKr = MSG.ROOMS[current] || current;\n\n    this.game.print(MSG.MAP_HEADER, 'system');\n    this.game.print('');\n\n    const lines = buildAsciiMapLines({\n      hasShortcut: this.hasShortcut,\n      lockedRooms: this.lockedRooms,\n      current,\n    });\n    lines.forEach(line => this.game.print(line));\n\n    this.game.print('');\n    this.game.print(`í˜„ì¬ ìœ„ì¹˜: â˜… ${currentKr} (${current})`, 'success');\n\n    // ì—°ê²°ëœ ë°© í‘œì‹œ\n    const available = this.getAvailableRooms(current);\n    this.game.print('');\n    this.game.print('ì´ë™ ê°€ëŠ¥:', 'system');\n    available.forEach(({ room, roomKr, locked }) => {\n      const lockIcon = locked ? ' ğŸ”’' : '';\n      this.game.print(`  cd ${room} - ${roomKr}${lockIcon}`);\n    });\n\n    if (this.lockedRooms.size > 0) {\n      this.game.print('');\n      this.game.print('ğŸ”’ = ì ê¸´ êµ¬ì—­ (engineer ê¶Œí•œìœ¼ë¡œ unlock ë˜ëŠ” í‚¤ì¹´ë“œ í•„ìš”)', 'warning');\n    }\n\n    if (this.hasShortcut) {\n      this.game.print('');\n      this.game.print('âœ¨ ë‹¨ì¶• ê²½ë¡œ í™œì„±í™”: hub â†” airlock', 'success');\n    }\n  }\n}\n