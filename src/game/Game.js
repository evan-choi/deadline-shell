/**\n * Game - Core game logic for DEADLINE SHELL\n * ì»¤ë§¨ë“œëŠ” ì˜ì–´, ì„¤ëª…ì€ í•œê¸€\n */\n\nimport { MSG } from './messages.js';\nimport { Tutorial } from './Tutorial.js';\nimport { Objectives } from './Objectives.js';\nimport { TypingChallenge } from './TypingChallenge.js';\nimport { Events } from './Events.js';\nimport { Meta } from './Meta.js';\nimport { GameMap } from './Map.js';\nimport { Achievements } from './Achievements.js';\nimport { AchievementsUI } from './AchievementsUI.js';\nimport { LeftPanelUI } from './LeftPanelUI.js';\n\nexport class Game {\n  constructor({ outputEl, inputEl, promptEl, hudEl, terminalEl, crt }) {\n    this.outputEl = outputEl;\n    this.inputEl = inputEl;\n    this.promptEl = promptEl;\n    this.hudEl = hudEl;\n    this.terminalEl = terminalEl;\n    this.crt = crt;\n\n    this.state = {\n      running: false,\n      paused: false,\n      permission: 'guest',\n      location: 'hub',\n      resources: {\n        hp: 100,\n        o2: 100,\n        power: 50,\n        noise: 0,\n      },\n      time: 0,\n      enemy: { distance: 5 },\n      doorLocked: false,\n\n      // ë©”íƒ€ í•´ê¸ˆ ë³´ë„ˆìŠ¤\n      earlyDrainRelief: false,\n      hasEmergencyO2: false,\n      hasTempSuToken: false,\n      hasEngineerKeycard: false,\n    };\n\n    this.tickInterval = null;\n    this.history = [];\n    this.historyIndex = -1;\n\n    // Panels\n    this.leftPanel = new LeftPanelUI();\n\n    // Modules\n    this.tutorial = new Tutorial(this);\n    this.objectives = new Objectives(this);\n    this.typingChallenge = new TypingChallenge(this);\n    this.events = new Events(this);\n    this.meta = new Meta(this);\n    this.map = new GameMap(this);\n\n    // Achievements\n    this.achievements = new Achievements(this);\n    this.achievementsUI = new AchievementsUI(this.achievements, this.meta);\n\n    // Bind input\n    this.inputEl.addEventListener('keydown', (e) => this.handleInput(e));\n  }\n\n  start() {\n    this.state.running = true;\n    this.state.paused = false;\n\n    // ëŸ° í”Œë˜ê·¸ ë¦¬ì…‹\n    this.achievements.resetRunFlags();\n\n    // ì‹œì‘ ë³´ë„ˆìŠ¤\n    const bonuses = this.meta.applyStartBonuses();\n\n    // íŠœí† ë¦¬ì–¼ ì¸íŠ¸ë¡œ\n    this.tutorial.showIntro();\n\n    // ì¢Œì¸¡ íŒ¨ë„\n    this.leftPanel.logEvent('ì‹œìŠ¤í…œ ëª¨ë‹ˆí„°ë§ ì‹œì‘', 'info');\n\n    // íŠœí† ë¦¬ì–¼ ëŸ°ì´ ì•„ë‹ˆë©´(ì´ë¯¸ ì™„ë£Œ) ëœë¤ ìš”ì†Œ ì•ˆë‚´\n    if (this.tutorial.isCompleted()) {\n      if (this.map.lockedRooms.size > 0) {\n        const locked = Array.from(this.map.lockedRooms).map(r => MSG.ROOMS[r]).join(', ');\n        this.leftPanel.logEvent(`ğŸ”’ ì ê¸´ êµ¬ì—­: ${locked}`, 'warning');\n      }\n      if (bonuses.length > 0) {\n        bonuses.forEach(b => this.leftPanel.logEvent(`âœ“ ì‹œì‘ ë³´ë„ˆìŠ¤: ${b}`, 'success'));\n      }\n    } else {\n      this.leftPanel.logEvent('íŠœí† ë¦¬ì–¼ ëŸ°: ì´ë²¤íŠ¸/ì ê¸ˆ ë¹„í™œì„±í™”', 'info');\n    }\n\n    setTimeout(() => {\n      this.tickInterval = setInterval(() => this.tick(), 1000);\n    }, 1200);\n\n    this.updateHUD();\n    this.inputEl.focus();\n\n    // ì—…ì  ì¹´ìš´í„° ì²´í¬\n    this.achievements.checkRuns(this.meta.saved.stats.totalRuns);\n    this.achievements.checkTotalData(this.meta.saved.totalData);\n  }\n\n  pause() {\n    this.state.paused = true;\n    if (this.tickInterval) {\n      clearInterval(this.tickInterval);\n      this.tickInterval = null;\n    }\n  }\n\n  resume() {\n    if (this.state.running && this.state.paused) {\n      this.state.paused = false;\n      this.tickInterval = setInterval(() => this.tick(), 1000);\n    }\n  }\n\n  tick() {\n    if (this.state.paused) return;\n\n    const { resources, enemy } = this.state;\n\n    // O2 drain\n    if (!(this.state.earlyDrainRelief && this.state.time < 30)) {\n      resources.o2 = Math.max(0, resources.o2 - 1);\n    }\n\n    // Noise decay\n    resources.noise = Math.max(0, resources.noise - 1);\n\n    // time\n    this.state.time++;\n\n    // enemy movement\n    if (this.state.time % 3 === 0 && resources.noise > 30) {\n      enemy.distance = Math.max(0, enemy.distance - 1);\n    }\n\n    // danger escape counter\n    if (enemy.distance === 1) {\n      this.meta.onDangerEscape();\n      this.achievements.check('danger_escape');\n    }\n\n    // events\n    this.events.tick();\n\n    // free-play hints after tutorial\n    this.tutorial.checkHint();\n\n    // visuals\n    this.updateHUD();\n    this.updateCRT();\n    this.achievementsUI.updateStats();\n\n    // death\n    if (resources.o2 <= 0 || resources.hp <= 0 || enemy.distance === 0) {\n      this.gameOver();\n    }\n  }\n\n  handleInput(e) {\n    if (e.key === 'Enter') {\n      const command = this.inputEl.value.trim();\n      if (command) {\n        this.history.push(command);\n        this.historyIndex = this.history.length;\n\n        if (this.typingChallenge.isActive()) {\n          this.print(`> ${command}`);\n          this.typingChallenge.checkInput(command);\n        } else {\n          this.executeCommand(command);\n        }\n      }\n      this.inputEl.value = '';\n    } else if (e.key === 'ArrowUp') {\n      e.preventDefault();\n      if (this.historyIndex > 0) {\n        this.historyIndex--;\n        this.inputEl.value = this.history[this.historyIndex];\n      }\n    } else if (e.key === 'ArrowDown') {\n      e.preventDefault();\n      if (this.historyIndex < this.history.length - 1) {\n        this.historyIndex++;\n        this.inputEl.value = this.history[this.historyIndex];\n      } else {\n        this.historyIndex = this.history.length;\n        this.inputEl.value = '';\n      }\n    } else if (e.key === 'Tab') {\n      e.preventDefault();\n      this.autoComplete();\n    }\n  }\n\n  autoComplete() {\n    const input = this.inputEl.value.toLowerCase();\n    const commands = [\n      'help', 'status', 'scan', 'cd', 'run', 'ls', 'map', 'objectives',\n      'hide', 'repair', 'login', 'su', 'lock', 'unlock', 'escape',\n      'shop', 'stats', 'buy', 'use', 'achievements'\n    ];\n    const match = commands.find(cmd => cmd.startsWith(input));\n    if (match) this.inputEl.value = match;\n  }\n\n  executeCommand(command) {\n    const normalized = command.trim().toLowerCase();\n\n    // tutorial pre-hint (no blocking)\n    this.tutorial.beforeExecute(normalized);\n\n    // always show user input\n    this.print(`> ${command}`);\n\n    // glitch fail\n    if (this.events.checkGlitchFail()) {\n      this.tutorial.onExecuted(normalized, false);\n      return;\n    }\n\n    const parts = normalized.split(' ');\n    const cmd = parts[0];\n    const args = parts.slice(1);\n\n    // meta commands don't make noise\n    const metaCmds = ['shop', 'stats', 'buy', 'achievements'];\n    if (!metaCmds.includes(cmd)) {\n      this.state.resources.noise = Math.min(100, this.state.resources.noise + 2);\n    }\n\n    // achievements: command usage\n    this.achievements.check('command', { cmd: normalized });\n\n    let success = true;\n\n    switch (cmd) {\n      case 'help': this.cmdHelp(); break;\n      case 'status': this.cmdStatus(); break;\n      case 'scan': success = this.cmdScan(); break;\n      case 'cd': success = this.cmdCd(args[0]); break;\n      case 'run': success = this.cmdRun(args[0]); break;\n      case 'ls': this.cmdLs(); break;\n      case 'map': this.cmdMap(); break;\n      case 'objectives': this.cmdObjectives(); break;\n      case 'hide': this.cmdHide(); break;\n      case 'repair': success = this.cmdRepair(); break;\n      case 'login': success = this.cmdLogin(args[0]); break;\n      case 'su': success = this.cmdSu(); break;\n      case 'escape': success = this.cmdEscape(); break;\n      case 'lock':\n        if (args[0] === 'door') { this.cmdLockDoor(); }\n        else { this.print(MSG.CMD_NOT_FOUND(cmd), 'error'); success = false; }\n        break;\n      case 'unlock':\n        if (args[0] === 'door') { this.cmdUnlockDoor(); }\n        else if (args[0]) { success = this.cmdUnlockRoom(args[0]); }\n        else { this.print(MSG.CMD_NOT_FOUND(cmd), 'error'); success = false; }\n        break;\n      case 'shop': this.cmdShop(); break;\n      case 'stats': this.cmdStats(); break;\n      case 'buy': success = this.cmdBuy(parseInt(args[0])); break;\n      case 'use': success = this.cmdUse(args[0]); break;\n      case 'achievements': this.achievements.showList(); break;\n      default:\n        this.print(MSG.CMD_NOT_FOUND(cmd), 'error');\n        this.triggerError();\n        success = false;\n    }\n\n    // tutorial progress updates only on success\n    this.tutorial.onExecuted(normalized, success);\n\n    this.updateHUD();\n    this.updateCRT();\n  }\n\n  cmdHelp() {\n    this.print(MSG.HELP_HEADER, 'system');\n    this.print('');\n    for (const [cmd, desc] of Object.entries(MSG.HELP_CMDS)) {\n      this.print(`  ${cmd.padEnd(12)} - ${desc}`);\n    }\n  }\n\n  cmdStatus() {\n    const { resources, location, permission } = this.state;\n    const roomKr = MSG.ROOMS[location] || location;\n    const permKr = MSG.PERMISSION[permission] || permission;\n\n    this.print(MSG.STATUS_HEADER, 'system');\n    this.print(`${MSG.STATUS_LOCATION}: ${roomKr} (${location})`);\n    this.print(`${MSG.STATUS_PERMISSION}: ${permKr} (${permission})`);\n    this.print('');\n    this.print(`HP: ${resources.hp}  O2: ${resources.o2}%`);\n    this.print(`ì „ë ¥: ${resources.power}  ì†ŒìŒ: ${resources.noise}`);\n    this.print('');\n    this.print(`ëª©í‘œ ì§„í–‰: ${this.objectives.getCompletedCount()}/2`, 'system');\n    this.print(`ë³´ìœ  DATA: ${this.meta.saved.totalData}`, 'system');\n\n    this.print('ì´ë²¤íŠ¸/ìƒíƒœëŠ” ì¢Œì¸¡ íŒ¨ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”.', 'system');\n  }\n\n  cmdScan() {\n    if (this.events.isBlackout()) {\n      this.print('[ì˜¤ë¥˜] ì •ì „ìœ¼ë¡œ ìŠ¤ìº”ì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. (ì¢Œì¸¡ íŒ¨ë„ ì°¸ê³ )', 'error');\n      this.triggerError();\n      return false;\n    }\n\n    this.state.resources.noise = Math.min(100, this.state.resources.noise + 2);\n    this.print(MSG.SCAN_START, 'system');\n\n    const dist = this.state.enemy.distance;\n    let msg, type;\n\n    if (dist >= 5) { msg = MSG.SCAN_ENEMY_FAR; type = 'success'; }\n    else if (dist >= 3) { msg = MSG.SCAN_ENEMY_APPROACHING; type = 'warning'; }\n    else if (dist >= 1) { msg = MSG.SCAN_ENEMY_NEAR; type = 'error'; }\n    else { msg = MSG.SCAN_ENEMY_CRITICAL; type = 'error'; }\n\n    this.print(msg, type);\n    this.print(`(ê±°ë¦¬: ${dist})`, 'system');\n\n    const leakRoom = this.events.getLeakRoom();\n    if (leakRoom) {\n      this.leftPanel.logEvent(`ğŸ’¨ ì‚°ì†Œ ëˆ„ì¶œ ê°ì§€: ${MSG.ROOMS[leakRoom]}`, 'warning');\n    }\n\n    return true;\n  }\n\n  cmdCd(room) {\n    if (!room) {\n      this.print(MSG.MOVE_USAGE, 'error');\n      return false;\n    }\n\n    const result = this.map.canMove(this.state.location, room);\n\n    if (!result.canMove) {\n      this.print(result.reason, 'error');\n      if (result.locked) {\n        this.leftPanel.logEvent(`ğŸ”’ ${MSG.ROOMS[room]} ì ê¹€: unlock ${room} í•„ìš”`, 'warning');\n      }\n      this.triggerError();\n      return false;\n    }\n\n    if (result.useKeycard) {\n      this.map.useKeycardOn(room);\n      this.leftPanel.logEvent('Engineer í‚¤ì¹´ë“œë¡œ ì ê¸ˆ í•´ì œ!', 'success');\n    }\n\n    this.state.location = room;\n    this.state.resources.noise = Math.min(100, this.state.resources.noise + 1);\n\n    const roomKr = MSG.ROOMS[room] || room;\n    this.print(MSG.MOVE_SUCCESS(room, roomKr), 'success');\n\n    const obj = this.objectives.getObjectiveForRoom(room);\n    if (obj) {\n      this.leftPanel.logEvent(`ëª©í‘œ ê°€ëŠ¥: ${obj.name}`, 'info');\n    }\n\n    if (this.events.getLeakRoom() === room) {\n      this.leftPanel.logEvent('ğŸ’¨ ê²½ê³ : ì´ ë°©ì—ì„œ ì‚°ì†Œê°€ ëˆ„ì¶œë˜ê³  ìˆìŠµë‹ˆë‹¤!', 'error');\n    }\n\n    return true;\n  }\n\n  cmdRun(room) {\n    if (!room) {\n      this.print('ì‚¬ìš©ë²•: run <ì¥ì†Œ>', 'error');\n      return false;\n    }\n\n    const result = this.map.canMove(this.state.location, room);\n    if (!result.canMove) {\n      this.print(result.reason, 'error');\n      this.triggerError();\n      return false;\n    }\n\n    this.state.resources.noise = Math.min(100, this.state.resources.noise + 3);\n    this.state.location = room;\n\n    const roomKr = MSG.ROOMS[room] || room;\n    this.print(`${roomKr}(ìœ¼)ë¡œ ë›°ì–´ê°‘ë‹ˆë‹¤! (ì†ŒìŒ +3)`, 'success');\n\n    if (this.events.getLeakRoom() === room) {\n      this.leftPanel.logEvent('ğŸ’¨ ê²½ê³ : ì´ ë°©ì—ì„œ ì‚°ì†Œê°€ ëˆ„ì¶œë˜ê³  ìˆìŠµë‹ˆë‹¤!', 'error');\n    }\n\n    return true;\n  }\n\n  cmdUnlockRoom(room) {\n    if (!this.map.lockedRooms.has(room)) {\n      this.print(`${room}ì€(ëŠ”) ì ê²¨ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.`, 'warning');\n      return false;\n    }\n\n    if (this.map.unlockRoom(room)) {\n      const roomKr = MSG.ROOMS[room] || room;\n      this.leftPanel.logEvent(`ğŸ”“ ì ê¸ˆ í•´ì œ: ${roomKr}`, 'success');\n      this.print(`${roomKr} ì ê¸ˆ í•´ì œ!`, 'success');\n      return true;\n    }\n    return false;\n  }\n\n  cmdLs() {\n    const { location } = this.state;\n    const roomKr = MSG.ROOMS[location] || location;\n\n    this.print(MSG.LS_HEADER, 'system');\n    this.print(`í˜„ì¬ ìœ„ì¹˜: ${roomKr}`, 'system');\n    this.print('');\n\n    const items = {\n      hub: ['í„°ë¯¸ë„', 'ë¹„ìƒ ì§€ë„'],\n      reactor: ['ì›ìë¡œ ì œì–´íŒ', 'ëƒ‰ê° ì‹œìŠ¤í…œ', 'ê³µêµ¬í•¨'],\n      medbay: ['ì˜ë£Œ í‚¤íŠ¸', 'ì‚°ì†Œ ìº”', 'ì§„ë‹¨ ì¥ë¹„'],\n      storage: ['ë¶€í’ˆ ìƒì', 'ë°°í„°ë¦¬', 'ì˜ˆë¹„ ë¶€í’ˆ'],\n      security: ['ë³´ì•ˆ ì½˜ì†”', 'í‚¤ì¹´ë“œ ë¦¬ë”ê¸°', 'ëª¨ë‹ˆí„°'],\n      airlock: ['íƒˆì¶œ í•´ì¹˜', 'ìš°ì£¼ë³µ', 'ë¹„ìƒ ë²„íŠ¼'],\n    };\n\n    const roomItems = items[location] || [];\n    if (roomItems.length > 0) {\n      this.print(MSG.LS_ITEMS);\n      roomItems.forEach(item => this.print(`  - ${item}`));\n    } else {\n      this.print(MSG.LS_NOTHING);\n    }\n\n    const obj = this.objectives.getObjectiveForRoom(location);\n    if (obj) {\n      this.print('');\n      this.print(`[ëª©í‘œ] ${obj.name} - repair ëª…ë ¹ìœ¼ë¡œ ìˆ˜í–‰`, 'warning');\n    }\n  }\n\n  cmdMap() {\n    this.map.showMap();\n  }\n\n  cmdObjectives() {\n    this.objectives.showStatus();\n  }\n\n  cmdHide() {\n    this.state.resources.noise = 0;\n    this.state.enemy.distance = Math.min(5, this.state.enemy.distance + 2);\n    this.print(MSG.HIDE_SUCCESS, 'success');\n    this.state.time += 2;\n  }\n\n  cmdLockDoor() {\n    const { resources, doorLocked } = this.state;\n\n    if (doorLocked) {\n      this.print(MSG.DOOR_ALREADY_LOCKED, 'warning');\n      return;\n    }\n\n    if (resources.power < 5) {\n      this.print(MSG.DOOR_NO_POWER, 'error');\n      return;\n    }\n\n    resources.power -= 5;\n    this.state.doorLocked = true;\n\n    this.leftPanel.logEvent('ğŸšª ë¬¸ ì ê¸ˆ (ì „ë ¥ -5)', 'info');\n    this.print(MSG.DOOR_LOCKED, 'success');\n  }\n\n  cmdUnlockDoor() {\n    if (!this.state.doorLocked) {\n      this.print(MSG.DOOR_ALREADY_UNLOCKED, 'warning');\n      return;\n    }\n\n    this.state.doorLocked = false;\n    this.leftPanel.logEvent('ğŸšª ë¬¸ ì ê¸ˆ í•´ì œ', 'info');\n    this.print(MSG.DOOR_UNLOCKED, 'success');\n  }\n\n  cmdLogin(level) {\n    if (!level) {\n      this