/**\n * Tutorial - ë‹¨ê³„í˜• íŠœí† ë¦¬ì–¼ (íƒˆì¶œê¹Œì§€ ê°€ì´ë“œ)\n * - ì»¤ë§¨ë“œë¥¼ ë§‰ì§€ ì•ŠìŒ (ì‹¤í–‰ì€ í—ˆìš©)\n * - ëŒ€ì‹  \"ì„±ê³µì ìœ¼ë¡œ ì‹¤í–‰ëœ\" ì»¤ë§¨ë“œê°€ í˜„ì¬ ë‹¨ê³„ì™€ ì¼ì¹˜í•  ë•Œë§Œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰\n */\n\nimport { MSG } from './messages.js';\n\nconst STORAGE_KEY = 'deadline-shell-tutorial';\n\nexport class Tutorial {\n  constructor(game) {\n    this.game = game;\n\n    // ë‹¨ê³„ ì •ì˜\n    this.steps = [\n      {\n        id: 'status',\n        instruction: 'í˜„ì¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.',\n        command: 'status',\n        hint: 'status ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n      },\n      {\n        id: 'scan',\n        instruction: 'ì£¼ë³€ì„ ìŠ¤ìº”í•´ ì ì˜ ê±°ë¦¬ë¥¼ í™•ì¸í•˜ì„¸ìš”.',\n        command: 'scan',\n        hint: 'scan ì„ ì…ë ¥í•˜ì„¸ìš”.',\n      },\n      {\n        id: 'map',\n        instruction: 'ì§€ë„ë¥¼ í™•ì¸í•´ ì´ë™ ê²½ë¡œë¥¼ íŒŒì•…í•˜ì„¸ìš”.',\n        command: 'map',\n        hint: 'map ì„ ì…ë ¥í•˜ì„¸ìš”.',\n      },\n      {\n        id: 'move_storage',\n        instruction: 'storage ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd storage',\n        hint: 'cd storage ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd storage',\n      },\n      {\n        id: 'move_security',\n        instruction: 'security ë¡œ ì´ë™í•˜ì„¸ìš”. (ê¶Œí•œ íšë“ ì¥ì†Œ)',\n        command: 'cd security',\n        hint: 'cd security ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd security',\n      },\n      {\n        id: 'login',\n        instruction: 'engineer ê¶Œí•œì„ íšë“í•˜ì„¸ìš”.',\n        command: 'login engineer',\n        hint: 'login engineer ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'login engineer',\n      },\n      {\n        id: 'objectives',\n        instruction: 'íƒˆì¶œ ëª©í‘œë¥¼ í™•ì¸í•˜ì„¸ìš”.',\n        command: 'objectives',\n        hint: 'objectives ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n      },\n      {\n        id: 'move_storage_back',\n        instruction: 'storage ë¡œ ëŒì•„ê°€ì„¸ìš”.',\n        command: 'cd storage',\n        hint: 'cd storage ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd storage',\n      },\n      {\n        id: 'move_hub',\n        instruction: 'hub ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd hub',\n        hint: 'cd hub ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd hub',\n      },\n      {\n        id: 'move_reactor',\n        instruction: 'reactor ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd reactor',\n        hint: 'cd reactor ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd reactor',\n      },\n      {\n        id: 'repair',\n        instruction: 'ì›ìë¡œë¥¼ ìˆ˜ë¦¬í•˜ì„¸ìš”. (íƒ€ì´í•‘ ì±Œë¦°ì§€)',\n        command: 'repair',\n        hint: 'repair ë¥¼ ì…ë ¥í•˜ê³ , í‘œì‹œëœ ë¬¸êµ¬ë¥¼ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.',\n        onComplete: () => {\n          // íŠœí† ë¦¬ì–¼ í¸ì˜: ëª©í‘œ 2ê°œ ì¡°ê±´ì„ ë°”ë¡œ ì±„ì›Œ íƒˆì¶œê¹Œì§€ ê²½í—˜ì‹œí‚¤ê¸°\n          if (this.game?.objectives?.objectives?.security) {\n            this.game.objectives.objectives.security.completed = true;\n          }\n          this.game.leftPanel?.logEvent('ğŸ§ª íŠœí† ë¦¬ì–¼: ë³´ì•ˆ ëª©í‘œê°€ ì‹œë®¬ë ˆì´ì…˜ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');\n        },\n      },\n      {\n        id: 'move_hub_back',\n        instruction: 'hub ë¡œ ëŒì•„ê°€ì„¸ìš”.',\n        command: 'cd hub',\n        hint: 'cd hub ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd hub',\n      },\n      {\n        id: 'move_storage_again',\n        instruction: 'storage ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd storage',\n        hint: 'cd storage ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd storage',\n      },\n      {\n        id: 'move_security_again',\n        instruction: 'security ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd security',\n        hint: 'cd security ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd security',\n      },\n      {\n        id: 'move_airlock',\n        instruction: 'airlock ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”.',\n        command: 'cd airlock',\n        hint: 'cd airlock ì„ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'cd airlock',\n      },\n      {\n        id: 'escape',\n        instruction: 'escape ë¡œ íƒˆì¶œí•˜ì„¸ìš”!',\n        command: 'escape',\n        hint: 'escape ë¥¼ ì…ë ¥í•˜ì„¸ìš”.',\n        validate: (cmd) => cmd === 'escape',\n      },\n    ];\n\n    this.currentStep = 0;\n    this.completed = false;\n\n    this.lastInputTime = Date.now();\n    this.lastReminderTime = 0;\n\n    this.enabled = true;\n\n    this.load();\n\n    // ììœ  í”Œë ˆì´ íŒíŠ¸ (íŠœí† ë¦¬ì–¼ ì™„ë£Œ í›„)\n    this.hintInterval = setInterval(() => this.checkHint(), 5000);\n  }\n\n  load() {\n    try {\n      const raw = localStorage.getItem(STORAGE_KEY);\n      if (raw) {\n        const data = JSON.parse(raw);\n        this.completed = data.completed || false;\n      }\n    } catch (e) {\n      console.warn('Tutorial load failed:', e);\n    }\n  }\n\n  save() {\n    try {\n      localStorage.setItem(STORAGE_KEY, JSON.stringify({ completed: this.completed }));\n    } catch (e) {\n      console.warn('Tutorial save failed:', e);\n    }\n  }\n\n  isCompleted() {\n    return this.completed;\n  }\n\n  showIntro() {\n    if (this.completed) {\n      setTimeout(() => {\n        this.game.print('');\n        this.game.print('[ì‹œìŠ¤í…œ] íŠœí† ë¦¬ì–¼ ì™„ë£Œë¨. ììœ ë¡­ê²Œ í”Œë ˆì´í•˜ì„¸ìš”.', 'system');\n        this.game.print('[TIP] help ë¡œ ëª…ë ¹ì–´ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.', 'system');\n      }, 500);\n      return;\n    }\n\n    // ìŠ¤í† ë¦¬ ì¶œë ¥\n    let delay = 0;\n    MSG.STORY_INTRO.forEach((line) => {\n      setTimeout(() => {\n        if (line === '') this.game.print('');\n        else if (line.startsWith('ê²½ê³ ')) this.game.print(line, 'warning');\n        else if (line.startsWith('[')) this.game.print(line, 'system');\n        else this.game.print(line);\n      }, delay);\n      delay += line === '' ? 100 : 250;\n    });\n\n    setTimeout(() => {\n      this.game.print('');\n      this.game.print('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—', 'warning');\n      this.game.print('â•‘         [í›ˆë ¨ í”„ë¡œí† ì½œ ì‹œì‘]       â•‘', 'warning');\n      this.game.print('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'warning');\n      this.game.print('');\n      this.game.print('ì§€ì‹œì— ë”°ë¼ íƒˆì¶œ ì ˆì°¨ë¥¼ ìµíˆì„¸ìš”. (ì…ë ¥ì€ ë§‰ì§€ ì•Šì§€ë§Œ, ì§„í–‰ì€ ë‹¨ê³„ëŒ€ë¡œ ë©ë‹ˆë‹¤.)', 'system');\n      this.game.print('');\n      this.showCurrentStep();\n    }, delay + 700);\n  }\n\n  getCurrentStep() {\n    return this.steps[this.currentStep] || null;\n  }\n\n  showCurrentStep() {\n    if (this.completed) return;\n    const step = this.getCurrentStep();\n    if (!step) return;\n\n    const progress = `[${this.currentStep + 1}/${this.steps.length}]`;\n    this.game.print(`${progress} ${step.instruction}`, 'info');\n    this.game.print(`    â†’ ${step.hint}`, 'system');\n\n    this.lastInputTime = Date.now();\n  }\n\n  /**\n   * ëª…ë ¹ ì‹¤í–‰ ì „ì— ì‚´ì§ ì•ˆë‚´ë§Œ í•¨ (ì°¨ë‹¨ âŒ)\n   */\n  beforeExecute(cmd) {\n    this.lastInputTime = Date.now();\n    if (this.completed) return;\n\n    const step = this.getCurrentStep();\n    if (!step) return;\n\n    const now = Date.now();\n    if (now - this.lastReminderTime < 2000) return; // ìŠ¤íŒ¸ ë°©ì§€\n\n    const normalized = cmd.trim().toLowerCase();\n\n    const isExpected = step.validate ? step.validate(normalized) : normalized === step.command;\n    if (!isExpected && normalized !== 'help') {\n      this.lastReminderTime = now;\n      this.game.print(`[í›ˆë ¨] ë‹¤ìŒ ë‹¨ê³„: ${step.command}`, 'system');\n    }\n  }\n\n  /**\n   * ëª…ë ¹ ì‹¤í–‰ í›„(ì„±ê³µ/ì‹¤íŒ¨) ì§„í–‰ ì²˜ë¦¬\n   */\n  onExecuted(cmd, success) {\n    if (this.completed) return;\n    if (!success) return;\n\n    const normalized = cmd.trim().toLowerCase();\n\n    // í˜„ì¬ ë‹¨ê³„ë¶€í„° ì•ìœ¼ë¡œ íƒìƒ‰í•´ì„œ, ì¼ì¹˜í•˜ëŠ” ê°€ì¥ ì• ë‹¨ê³„ë¡œ ì§„í–‰\n    let matchIndex = -1;\n    for (let i = this.currentStep; i < this.steps.length; i++) {\n      const step = this.steps[i];\n      const match = step.validate ? step.validate(normalized) : normalized === step.command;\n      if (match) {\n        matchIndex = i;\n        break;\n      }\n    }\n\n    if (matchIndex === -1) return;\n\n    if (matchIndex > this.currentStep) {\n      this.game.print('[í›ˆë ¨] ë‹¨ê³„ë¥¼ ì¼ë¶€ ê±´ë„ˆë›°ì—ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.', 'system');\n    }\n\n    // ë‹¨ê³„ ì™„ë£Œ ì²˜ë¦¬\n    const step = this.steps[matchIndex];\n    if (step.onComplete) {\n      step.onComplete();\n    }\n\n    this.currentStep = matchIndex + 1;\n\n    if (this.currentStep >= this.steps.length) {\n      this.completeTutorial();\n      return;\n    }\n\n    this.game.print('');\n    this.showCurrentStep();\n  }\n\n  completeTutorial() {\n    this.completed = true;\n    this.save();\n\n    if (this.game.achievements) {\n      this.game.achievements.check('tutorial_complete');\n    }\n\n    this.game.print('');\n    this.game.print('ğŸ‰ í›ˆë ¨ ì™„ë£Œ! ì´ì œë¶€í„°ëŠ” ììœ ë¡­ê²Œ í”Œë ˆì´í•˜ì„¸ìš”.', 'success');\n    this.game.print('[TIP] shop ìœ¼ë¡œ ë©”íƒ€ í•´ê¸ˆ / achievements ë¡œ ì—…ì  ëª©ë¡ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'system');\n  }\n\n  checkHint() {\n    if (!this.completed || !this.enabled) return;\n    if (!this.game.state.running || this.game.state.paused) return;\n\n    const idle = Date.now() - this.lastInputTime;\n    if (idle < 15000) return;\n\n    const { resources, enemy } = this.game.state;\n\n    if (resources.o2 < 20) {\n      this.game.print('[TIP] ì‚°ì†Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤! ì„œë‘ë¥´ì„¸ìš”.', 'system');\n      this.lastInputTime = Date.now();\n      return;\n    }\n\n    if (enemy.distance <= 2) {\n      this.game.print('[TIP] ì ì´ ê°€ê¹ìŠµë‹ˆë‹¤! hide ë¡œ ìˆ¨ê±°ë‚˜ ë¹ ë¥´ê²Œ ì´ë™í•˜ì„¸ìš”.', 'system');\n      this.lastInputTime = Date.now();\n      return;\n    }\n  }\n\n  destroy() {\n    if (this.hintInterval) {\n      clearInterval(this.hintInterval);\n      this.hintInterval = null;\n    }\n  }\n}\n